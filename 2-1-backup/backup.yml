---
- name: BACKUP ROUTER CONFIGURATIONS
  hosts: cisco
  connection: network_cli
  gather_facts: no
  vars:
    temp_dir: /var/lib/awx/projects/_15__demolab/2-1-backup/backup

  tasks:
    - name: BACKUP THE CONFIG
      ios_config:
        backup: yes
      register: config_output

    - name: RENAME BACKUP
      copy:
        src: "{{config_output.backup_path}}"
        dest: "{{ temp_dir }}/{{inventory_hostname}}.config"


- name: BACKUP ROUTER CONFIGURATIONS
  hosts: ansible
  gather_facts: no
  vars:
    dir: /home/ec2-user/backup
    temp_dir: /var/lib/awx/projects/_15__demolab/2-1-backup/backup/


  tasks:

    - name: Create directory for the backups
      file:
        path: "{{dir}}" 
        state: directory
        mode: 0755
#      become: yes
#      become_method: su
#      become_user: student1
#      become_pass: ansible


    - name: RENAME BACKUP
      copy:
        src: "{{temp_dir}}"
        dest: "{{ dir }}"


    - name: REMOVE NON CONFIG LINES
      lineinfile:
        path: "{{ dir }}/{{inventory_hostname}}.config"
        line: "Building configuration..."
        state: absent


    - name: REMOVE NON CONFIG LINES - REGEXP
      lineinfile:
        path: "{{ dir }}/{{inventory_hostname}}.config"
        regexp: 'Current configuration.*'
        state: absent  

